# **Online Judge (OJ) 系统架构设计**

## **技术栈：Vue3 \+ Flask \+ MySQL \+ Docker**

### **1\. 项目总体目录结构**

建议采用前后端分离的仓库结构，或者在一个大仓库下分目录存放。

/my-oj-project  
├── /backend                 \# Flask 后端 & 判题调度逻辑  
│   ├── /app  
│   │   ├── \_\_init\_\_.py      \# App 工厂模式初始化  
│   │   ├── /api             \# 路由接口 (RESTful API)  
│   │   │   ├── auth.py      \# 登录注册 (JWT)  
│   │   │   ├── problem.py   \# 题目管理 (增删改查)  
│   │   │   ├── submit.py    \# 提交代码/文件接口  
│   │   │   └── admin.py     \# 教师端特有接口  
│   │   ├── /models          \# SQLAlchemy 数据模型  
│   │   │   ├── user.py  
│   │   │   ├── problem.py  
│   │   │   └── submission.py  
│   │   ├── /services        \# 业务逻辑层  
│   │   │   ├── judge\_service.py \# 核心：调用 Docker 进行判题  
│   │   │   └── file\_service.py  \# 文件上传处理  
│   │   └── /utils           \# 工具函数  
│   ├── /judge\_sandbox       \# 判题沙箱相关  
│   │   ├── /runners         \# 针对不同语言的启动脚本  
│   │   │   ├── run\_acm.sh  
│   │   │   ├── run\_oop\_test.py  
│   │   │   └── run\_kaggle\_score.py  
│   │   └── Dockerfile       \# 用于构建判题环境的镜像  
│   ├── /uploads             \# 存放题目数据、学生提交文件 (挂载卷)  
│   │   ├── /problems        \# 题目测试用例/答案CSV  
│   │   └── /submissions     \# 学生提交的代码/CSV  
│   ├── config.py            \# 配置文件  
│   ├── run.py               \# 启动入口  
│   └── requirements.txt  
│  
├── /frontend                \# Vue3 前端  
│   ├── /public  
│   ├── /src  
│   │   ├── /api             \# Axios 封装与后端交互  
│   │   ├── /assets  
│   │   ├── /components      \# 公共组件 (如: MonacoEditor代码编辑器)  
│   │   ├── /views  
│   │   │   ├── /student     \# 学生端页面 (题目列表, 答题区, 排行榜)  
│   │   │   ├── /teacher     \# 教师端页面 (发布题目, 数据管理, 学生管理)  
│   │   │   └── /common      \# 登录, 404等  
│   │   ├── /router          \# 路由配置 (包含权限守卫)  
│   │   ├── /store           \# Pinia 状态管理 (User info, Token)  
│   │   └── App.vue  
│   ├── package.json  
│   └── vite.config.js  
│  
├── /docker                  \# 部署相关  
│   ├── /mysql               \# MySQL 配置及初始化脚本  
│   │   └── init.sql  
│   ├── /nginx               \# Nginx 配置 (反向代理)  
│   │   └── default.conf  
│   └── docker-compose.yml   \# 容器编排  
└── README.md

### **2\. 数据库设计 (MySQL)**

核心表结构简述：

#### **Users (用户表)**

* id: PK  
* username: varchar  
* password\_hash: varchar  
* role: enum('student', 'teacher')

#### **Problems (题目表)**

* id: PK  
* title: varchar  
* content: text (Markdown描述)  
* type: enum('acm', 'oop', 'kaggle')  
* time\_limit: int (ms)  
* memory\_limit: int (mb)  
* test\_case\_path: varchar (存放测试用例或正确CSV的路径)  
* template\_code: text (OOP模式下的类/函数模板)

#### **Submissions (提交记录表)**

* id: PK  
* user\_id: FK  
* problem\_id: FK  
* code\_path: varchar (保存代码文件或CSV文件的路径)  
* language: varchar (python, cpp, java, csv)  
* status: enum('Pending', 'Accepted', 'Wrong Answer', 'Time Limit Exceeded', 'Runtime Error')  
* score: float (Kaggle模式的分数)  
* output\_log: text (错误信息或评测日志)  
* created\_at: datetime

### **3\. 核心评测模式实现逻辑**

这是整个项目的难点，通过 Flask 调用 Docker API 或 subprocess 来启动临时的 Docker 容器进行隔离运行。

#### **模式 A: ACM 模式 (标准输入输出)**

1. **输入**: 学生提交完整的源代码（如 main.py 或 main.cpp）。  
2. **流程**:  
   * 后端将代码写入文件。  
   * 启动 Docker 容器，挂载代码和测试用例目录。  
   * 容器内编译（如果是C++）。  
   * 容器内运行：./user\_code \< input.txt \> user\_output.txt。  
   * 比较 user\_output.txt 和标准答案 output.txt。  
   * 监控内存和时间（可以使用 Docker 的 resource limit 参数）。

#### **模式 B: 面向对象模式 (OOP / 单元测试)**

1. **输入**: 学生补全类或函数（如 class Solution）。  
2. **流程**:  
   * **教师端**: 教师上传一个 test\_runner.py（包含 unittest 或 pytest 逻辑），该脚本会 import 学生的代码并运行测试用例。  
   * **后端**: 将学生的代码保存为 solution.py。  
   * 启动 Docker 容器。  
   * 容器内运行：python test\_runner.py。  
   * **判定**: 根据测试脚本的返回值（Exit Code）或输出的 JSON 结果判断是否通过。

#### **模式 C: Kaggle 竞赛模式 (CSV 提交)**

1. **输入**: 学生不提交代码，只上传 submission.csv。  
2. **流程**:  
   * **教师端**: 上传 ground\_truth.csv (真实标签) 和 score\_script.py (评分脚本，如计算 RMSE, F1-Score)。  
   * **后端**: 保存 student 文件。  
   * 启动 Docker 容器 (需要包含 numpy/pandas 环境)。  
   * 容器内运行：python score\_script.py \--truth ground\_truth.csv \--submit submission.csv。  
   * **输出**: 脚本直接打印分数，后端捕获 stdout 更新到数据库。

### **4\. Docker Compose 编排示意**

用于一键启动整个服务（后端、数据库、前端）。

version: '3.8'

services:  
  mysql:  
    image: mysql:8.0  
    environment:  
      MYSQL\_ROOT\_PASSWORD: root  
      MYSQL\_DATABASE: oj\_db  
    volumes:  
      \- ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql  
      \- mysql\_data:/var/lib/mysql

  backend:  
    build: ./backend  
    ports:  
      \- "5000:5000"  
    volumes:  
      \- ./backend:/app  
      \- /var/run/docker.sock:/var/run/docker.sock \# 关键：让Flask能操作宿主机Docker进行判题  
      \- ./backend/uploads:/app/uploads  
    depends\_on:  
      \- mysql

  frontend:  
    build: ./frontend  
    ports:  
      \- "80:80"  
    depends\_on:  
      \- backend

volumes:  
  mysql\_data:

### **5\. 开发建议**

1. **安全性 (Security)**:  
   * 判题必须在 Docker 容器中进行，且容器网络应该断开 (network\_mode: none)，防止 student 代码攻击内网。  
   * 设置 pids\_limit 防止 Fork 炸弹。  
   * 如果是 Python 代码，注意过滤像 os.system 这样的危险代码（虽然 Docker 已经隔离，但防患未然）。  
2. **Vue3 前端组件**:  
   * 推荐使用 monaco-editor 库来实现网页版的代码编辑器（VS Code 风格）。  
   * 使用 Element Plus 或 Ant Design Vue 快速搭建管理后台。  
3. **异步处理**:  
   * 判题是一个耗时操作。建议引入 Redis \+ Celery。Flask 接收提交后，将任务扔给 Celery Worker，Worker 跑完 Docker 后更新 MySQL 状态。这样前端不会卡死，可以轮询状态。

### **6. 当前开发进度汇报 (截至当前)**

#### **后端 (Flask) - 已完成**
- [x] **基础架构**：App 工厂模式、JWT 认证工具类。
- [x] **数据模型**：User, Problem, Submission, Dataset 模型定义及迁移。
- [x] **API 接口**：
  - 用户认证 (`auth.py`)：注册、登录。
  - 题目管理 (`problem.py`)：增删改查、测试用例 Zip 上传与解压。
  - 提交管理 (`submission.py`)：异步判题调度、提交详情查询。
  - 数据集管理 (`dataset.py`)：列表获取、文件上传、文件下载。
  - 用户中心 (`user.py`)：个人提交记录查询。

#### **前端 (Vue3) - 已完成**
- [x] **基础环境**：Vite + Vue3 + Router + Pinia 搭建。
- [x] **核心页面**：
  - 首页、登录页、个人资料页。
  - 题目列表页、题目详情页（集成代码提交）。
  - 提交详情页（查看状态与日志）。
  - 数据集列表页。

#### **核心评测逻辑 - 进行中**
- [x] **异步调度**：基于 `threading` 的异步判题框架已跑通。
- [x] **OOP 模式**：`oop.py` 服务初步实现。
- [ ] **沙箱隔离**：Docker 容器运行环境的安全性配置与资源限制需进一步压测。
- [ ] **管理后台**：`src/views/admin` 目录已建立，具体管理页面待开发。
